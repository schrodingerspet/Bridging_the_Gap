<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign Up & Login - Bridging the Gap</title>
  
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    /* Global Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Poppins", sans-serif;
      background: url('https://res.cloudinary.com/ddkisbcrp/image/upload/f_auto,q_auto/v1/anime/aftuw166jigihk5ziykl') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    /* Dark overlay to improve text readability */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: -1;
    }
    /* Form Wrapper */
    .wrapper {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      max-width: 500px;
      width: 90%;
      padding: 40px;
      animation: fadeIn 0.7s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* Form Header */
    .wrapper h1 {
      color: white;
      font-size: 2.2rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .wrapper h1 span {
      color: #4a90e2;
    }
    .toggle-form {
      display: block;
      color: #4a90e2;
      font-weight: 500;
      margin-bottom: 30px;
      cursor: pointer;
      transition: color 0.3s;
    }
    .toggle-form:hover {
      color: #357abd;
    }
    /* Form */
    .form-group {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-group input {
      flex: 1;
    }
    label {
      display: block;
      color: white;
      font-weight: 500;
      margin-bottom: 8px;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 1rem;
      color: white;
      outline: none;
      transition: border-color 0.3s;
    }
    input[type="text"]::placeholder,
    input[type="email"]::placeholder,
    input[type="password"]::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: #4a90e2;
    }
    .password-container {
      position: relative;
    }
    .password-container .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      cursor: pointer;
    }
    /* Buttons */
    .button-group {
      display: flex;
      justify-content: center; /* Center the button */
      margin-top: 20px;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s;
    }
    .primary-btn {
      background: #4a90e2;
      color: white;
    }
    .primary-btn.signup-btn {
      width: 60%; /* Increased by 50% as per previous requirement */
    }
    .primary-btn.login-btn {
      width: 100%; /* Updated to match Admin Login button */
    }
    .primary-btn:hover {
      background: #357abd;
      transform: translateY(-2px);
    }
    #admin-login-btn {
      background: #a83232;
      margin-top: 15px;
      width: 100%;
    }
    #admin-login-btn:hover {
      background: #8b2a2a;
      transform: translateY(-2px);
    }
    /* Forgot Password */
    #forgot-password {
      display: block;
      text-align: right;
      color: #4a90e2;
      font-size: 0.9rem;
      margin: 5px 0 15px 0;
      text-decoration: none;
    }
    #forgot-password:hover {
      text-decoration: underline;
      color: #357abd;
    }
    /* Status Message */
    #status-message {
      margin-top: 15px;
      text-align: center;
      font-size: 0.95rem;
      color: #e6007e;
    }
    .hidden {
      display: none;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .wrapper {
        max-width: 400px;
        width: 95%;
        padding: 20px;
      }
      .form-group {
        flex-direction: column;
        gap: 0;
      }
      .primary-btn.signup-btn {
        width: 100%; /* Full width on smaller screens */
      }
      .primary-btn.login-btn {
        width: 100%; /* Already full width */
      }
    }
  </style>
</head>
<body>
  <!-- Form Wrapper -->
  <div class="wrapper">
    <!-- Sign-Up Section -->
    <div id="signup-section">
      <h1>Create new account<span>.</span></h1>
      <span id="toggle-to-login" class="toggle-form">Already a member? Log in</span>
      <form id="signup-form">
        <div class="form-group">
          <div>
            <label for="signup-firstname">First name</label>
            <input type="text" id="signup-firstname" name="firstname" required placeholder="First name" />
          </div>
          <div>
            <label for="signup-lastname">Last name</label>
            <input type="text" id="signup-lastname" name="lastname" required placeholder="Last name" />
          </div>
        </div>
        <div>
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" name="email" required placeholder="Your email" />
        </div>
        <div>
          <label for="signup-password">Password</label>
          <div class="password-container">
            <input type="password" id="signup-password" name="password" required placeholder="Choose a password" />
            <i class="fas fa-eye toggle-password" id="toggle-signup-password"></i>
          </div>
        </div>
        <div class="button-group">
          <button type="submit" class="primary-btn signup-btn">Create account</button>
        </div>
      </form>
    </div>
<!-- Login Section -->
<div id="login-section" class="hidden">
  <h1>LOGIN<span>.</span></h1>
  <span id="toggle-to-signup" class="toggle-form">No account? Sign Up</span>
  <form id="login-form">
    <div>
      <label for="login-email">Email</label>
      <input type="email" id="login-email" name="email" required placeholder="Your email" />
    </div>
    <div>
      <label for="login-password">Password</label>
      <div class="password-container">
        <input type="password" id="login-password" name="password" required placeholder="Your password" />
        <i class="fas fa-eye toggle-password" id="toggle-login-password"></i>
      </div>
      <a href="#" id="forgot-password">Forgot Password?</a>
    </div>
    <div class="button-group">
      <button type="submit" class="primary-btn login-btn">Login</button>
    </div>
  </form>
  <button id="admin-login-btn">Admin Login</button>
</div>

<div id="status-message"></div>

  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD9Y_saGbwRdVsJr_zyFjwAayY8dkBUrXg",
      authDomain: "bridging-the-gap-af65a.firebaseapp.com",
      projectId: "bridging-the-gap-af65a",
      storageBucket: "bridging-the-gap-af65a.firebasestorage.app",
      messagingSenderId: "608387568756",
      appId: "1:608387568756:web:a563a78ea0e6e61d3dad21",
      measurementId: "G-9V1P6M82KD"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Flag to determine if admin login is attempted
    let adminLoginAttempted = false;

    // Form Toggle Listeners
    const signupSection = document.getElementById('signup-section');
    const loginSection = document.getElementById('login-section');
    const toggleToLogin = document.getElementById('toggle-to-login');
    const toggleToSignup = document.getElementById('toggle-to-signup');

    toggleToLogin.addEventListener('click', () => {
      signupSection.classList.add('hidden');
      loginSection.classList.remove('hidden');
      document.getElementById('status-message').innerText = '';
    });

    toggleToSignup.addEventListener('click', () => {
      loginSection.classList.add('hidden');
      signupSection.classList.remove('hidden');
      document.getElementById('status-message').innerText = '';
    });

    // Password Visibility Toggle
    const toggleSignupPassword = document.getElementById('toggle-signup-password');
    const signupPassword = document.getElementById('signup-password');
    const toggleLoginPassword = document.getElementById('toggle-login-password');
    const loginPassword = document.getElementById('login-password');

    toggleSignupPassword.addEventListener('click', () => {
      const type = signupPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      signupPassword.setAttribute('type', type);
      toggleSignupPassword.classList.toggle('fa-eye');
      toggleSignupPassword.classList.toggle('fa-eye-slash');
    });

    toggleLoginPassword.addEventListener('click', () => {
      const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      loginPassword.setAttribute('type', type);
      toggleLoginPassword.classList.toggle('fa-eye');
      toggleLoginPassword.classList.toggle('fa-eye-slash');
    });

    // Sign-Up Form Submission with Auto-Reload Upon Email Verification
    document.getElementById('signup-form').addEventListener('submit', function(event) {
      event.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const firstname = document.getElementById('signup-firstname').value;
      const lastname = document.getElementById('signup-lastname').value;

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          // Send email verification and instruct user to verify
          user.sendEmailVerification().then(() => {
            document.getElementById('status-message').innerText =
              `Account created! Please verify your email (${user.email}). We will log you in automatically once verified.`;
          });
          // Store additional user data in Firestore
          db.collection('users').doc(user.uid).set({
            firstname: firstname,
            lastname: lastname,
            email: user.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          // Check verification every 3 seconds
          const verificationInterval = setInterval(() => {
            user.reload().then(() => {
              if (user.emailVerified) {
                clearInterval(verificationInterval);
                document.getElementById('status-message').innerText = 'Email verified! Logging you in...';
                setTimeout(() => {
                  if (adminLoginAttempted) {
                    window.location.replace("admin-dashboard.html");
                  } else {
                    window.location.replace("dashboard.html");
                  }
                }, 3000);
              }
            });
          }, 3000);
        })
        .catch((error) => {
          document.getElementById('status-message').innerText = `Sign-up failed: ${error.message}`;
        });
    });

    // Login Form Submission for Regular Users
    document.getElementById('login-form').addEventListener('submit', function(event) {
      event.preventDefault();
      adminLoginAttempted = false;
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          if (user.emailVerified) {
            db.collection('users').doc(user.uid).set({
              email: user.email,
              lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            window.location.replace("dashboard.html");
          } else {
            user.sendEmailVerification().then(() => {
              document.getElementById('status-message').innerText =
                `Please verify your email. A link has been sent to ${user.email}.`;
            });
            auth.signOut();
          }
        })
        .catch((error) => {
          document.getElementById('status-message').innerText = `Login failed: ${error.message}`;
        });
    });

    // Admin Login Submission
    document.getElementById('admin-login-btn').addEventListener('click', function() {
      adminLoginAttempted = true;
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        document.getElementById('status-message').innerText = "Please enter email and password for admin login.";
        return;
      }

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          if (!user.emailVerified) {
            user.sendEmailVerification();
            auth.signOut();
            document.getElementById('status-message').innerText = `Please verify your email (${user.email}) for admin access.`;
            return;
          }
          db.collection('admins').doc(user.uid).get()
            .then((doc) => {
              if (doc.exists && doc.data().role === 'admin') {
                window.location.replace("admin-dashboard.html");
              } else {
                auth.signOut();
                document.getElementById('status-message').innerText = "Access denied. You are not authorized as admin.";
              }
            })
            .catch((error) => {
              console.error("Error checking admin status:", error);
              document.getElementById('status-message').innerText = "Error verifying admin status.";
            });
        })
        .catch((error) => {
          document.getElementById('status-message').innerText = `Admin login failed: ${error.message}`;
        });
    });

    // Forgot Password Link
    document.getElementById('forgot-password').addEventListener('click', function (e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;

      if (!email) {
        document.getElementById('status-message').innerText = "Please enter your email above to reset your password.";
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          document.getElementById('status-message').innerText = `Password reset email sent to ${email}. Check your inbox.`;
        })
        .catch((error) => {
          console.error(error);
          document.getElementById('status-message').innerText = error.message;
        });
    });

    // Auto-redirect if user is already logged in & verified (if not an admin attempt)
    auth.onAuthStateChanged((user) => {
      if (user && user.emailVerified && !adminLoginAttempted) {
        window.location.replace("dashboard.html");
      }
    });

    // Handle browser back navigation to ensure redirection to index.html
    window.onpopstate = function() {
      window.location.replace("index.html");
    };
  </script>
</body>
</html>
